
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>理解ThreadLocal | 特喜欢秋天的人</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="威威小威">
    

    
    <meta name="description" content="前言看到《Java 编程思想》的21.3小节，只用了一个小节介绍 ThreadLocal 的使用，但是不是很懂，于是找了点资料学习一下，下面是这篇文章的主线：

什么是 ThreadLocal，为什么要提出这个概念？——共享资源的访问问题
synchronized——串行访问
volatile——主内存刷新，不存在线程副本
ThreadLocal——线程空间内的全局变量


文档 &amp;amp; 源码">
<meta property="og:type" content="article">
<meta property="og:title" content="理解ThreadLocal">
<meta property="og:url" content="http://mwplll.github.io/2015/08/17/理解ThreadLocal/index.html">
<meta property="og:site_name" content="特喜欢秋天的人">
<meta property="og:description" content="前言看到《Java 编程思想》的21.3小节，只用了一个小节介绍 ThreadLocal 的使用，但是不是很懂，于是找了点资料学习一下，下面是这篇文章的主线：

什么是 ThreadLocal，为什么要提出这个概念？——共享资源的访问问题
synchronized——串行访问
volatile——主内存刷新，不存在线程副本
ThreadLocal——线程空间内的全局变量


文档 &amp;amp; 源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="理解ThreadLocal">
<meta name="twitter:description" content="前言看到《Java 编程思想》的21.3小节，只用了一个小节介绍 ThreadLocal 的使用，但是不是很懂，于是找了点资料学习一下，下面是这篇文章的主线：

什么是 ThreadLocal，为什么要提出这个概念？——共享资源的访问问题
synchronized——串行访问
volatile——主内存刷新，不存在线程副本
ThreadLocal——线程空间内的全局变量


文档 &amp;amp; 源码">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="特喜欢秋天的人">特喜欢秋天的人</a></h1>
				<h2 class="blog-motto">从春天到秋天，从前端写到后台</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/categories">分类</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:mwplll.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/17/理解ThreadLocal/" title="理解ThreadLocal" itemprop="url">理解ThreadLocal</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="威威小威" target="_blank" itemprop="author">威威小威</a>
		
  <p class="article-time">
    <time datetime="2015-08-16T16:32:59.000Z" itemprop="datePublished"> 发表于 2015-08-17</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、什么是_ThreadLocal，为什么要提出这个概念？"><span class="toc-number">1.1.</span> <span class="toc-text">一、什么是 ThreadLocal，为什么要提出这个概念？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、文档_&_源码分析"><span class="toc-number">1.2.</span> <span class="toc-text">二、文档 & 源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、探究一下为什么这么设计？"><span class="toc-number">1.3.</span> <span class="toc-text">三、探究一下为什么这么设计？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四、实际中如何正确使用？"><span class="toc-number">1.4.</span> <span class="toc-text">四、实际中如何正确使用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#五、有什么缺点？有危险吗？"><span class="toc-number">1.5.</span> <span class="toc-text">五、有什么缺点？有危险吗？</span></a></li></ol></li></ol>
		
		</div>
		
		<h3 id="前言">前言</h3><p>看到《Java 编程思想》的21.3小节，只用了一个小节介绍 ThreadLocal 的使用，但是不是很懂，于是找了点资料学习一下，下面是这篇文章的主线：</p>
<ol>
<li>什么是 ThreadLocal，为什么要提出这个概念？——共享资源的访问问题<ul>
<li>synchronized——串行访问</li>
<li>volatile——主内存刷新，不存在线程副本</li>
<li>ThreadLocal——线程空间内的全局变量</li>
</ul>
</li>
<li>文档 &amp; 源码分析</li>
<li>探究一下为什么这么设计？</li>
<li>实际中如何正确使用？</li>
<li>有什么缺点？有危险吗？</li>
</ol>
<p>下面就来分析分析吧，gogogo~~</p>
<h4 id="一、什么是_ThreadLocal，为什么要提出这个概念？">一、什么是 ThreadLocal，为什么要提出这个概念？</h4><p>多线程问题最让人抓狂的就是对共享资源的并发访问。目前为止，我见到的对共享资源的使用方法有：</p>
<ul>
<li>synchronized——串行访问</li>
<li>volatile——主内存刷新，不存在线程副本</li>
<li>ThreadLocal——线程空间内的全局变量</li>
</ul>
<p>synchronized 很简单，就是每个对象访问共享资源时，会检查对象头中的锁状态，然后进行串行访问共享资源；volatile 也很简单，它在使用中保证对变量的访问均在主内存进行，不存在对象副本，所以每个线程要使用的时候，都必须强制从主内存刷新，但是如果操作不具有原子性，也会导致共享资源的污染，所以 volatile 的使用场景要非常小心，在《深入理解 Java 虚拟机》中有详细的分析，这里就不细谈了；然后 ThreadLocal，其实 ThreadLocal 跟共享资源没关系，因为都是线程内部的，所以根本不存在共享这一说法，那它是干嘛的？下面会详细说明。</p>
<h4 id="二、文档_&amp;_源码分析">二、文档 &amp; 源码分析</h4><p><code>public class ThreadLocal&lt;T&gt; extends Object</code></p>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. <strong>ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)【注：一般为 private static 修饰，比如一个 userid 或者事务 id】</strong>.</p>
<p>Each thread holds an implicit reference to its copy of a thread-local variable as long as the thread is alive and the ThreadLocal instance is accessible; after a thread goes away, all of its copies of thread-local instances are subject to garbage collection (unless other references to these copies exist).</p>
</blockquote>
<p>文档说的很简单，其实源码也很简单的，核心部分就是 ThreadLocalMap。然后对这个 Map 的 init，get，set 操作。我们抓住关键部分看一下：</p>
<p>首先是 set()方法：</p>
<pre><code><span class="comment">//set 方法</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T <span class="keyword">value</span>)</span> </span>{
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    <span class="keyword">if</span> (map != <span class="keyword">null</span>)
        map.<span class="keyword">set</span>(<span class="keyword">this</span>, <span class="keyword">value</span>);
    <span class="function"><span class="keyword">else</span>
        <span class="title">createMap</span><span class="params">(t, <span class="keyword">value</span>)</span></span>;
}

<span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>{
    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);
}

<span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>{
    <span class="keyword">return</span> t.threadLocals;
}

<span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>{
    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);
}
</code></pre><p>在这个方法内部我们看到，首先通过 getMap(Thread t)方法获取和当前线程相关的 ThreadLocalMap，然后将变量的值设置到 ThreadLocalMap 对象中，当然如果获取到的ThreadLocalMap对象为空，就通过createMap方法创建。而 getMap()也很简单，就是获取和设置 Thread 类中的 threadLocals 变量，而这个变量的类型就是 ThreadLocalMap，这样进一步验证了上文中的观点：每个线程都有自己独立的 ThreadLocalMap 对象。</p>
<p>打开java.lang.Thread类的源代码，我们能得到更直观的证明：</p>
<pre><code>/* ThreadLocal values pertaining <span class="keyword">to</span> this thread. This map <span class="keyword">is</span> maintained
 * <span class="keyword">by</span> <span class="keyword">the</span> ThreadLocal <span class="type">class</span>. */
ThreadLocal.ThreadLocalMap threadLocals = null;
</code></pre><p>然后再看一下ThreadLocal类中的get()方法：</p>
<pre><code><span class="comment">//get 方法</span>
<span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>{
    Thread t = Thread.currentThread(); <span class="comment">//原来 Thread 中有 ThreadLocalMap 属性</span>
    ThreadLocalMap map = getMap(t);
    <span class="keyword">if</span> (map != <span class="keyword">null</span>) {
        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);
        <span class="keyword">if</span> (e != <span class="keyword">null</span>) {
            @SuppressWarnings(<span class="string">"unchecked"</span>)
            T result = (T)e.<span class="keyword">value</span>;
            <span class="keyword">return</span> result;
        }
    }
    <span class="keyword">return</span> setInitialValue();
}

<span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>{
    T <span class="keyword">value</span> = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    <span class="keyword">if</span> (map != <span class="keyword">null</span>)
        map.<span class="keyword">set</span>(<span class="keyword">this</span>, <span class="keyword">value</span>);
    <span class="function"><span class="keyword">else</span>
        <span class="title">createMap</span><span class="params">(t, <span class="keyword">value</span>)</span></span>;
    <span class="keyword">return</span> <span class="keyword">value</span>;
}
</code></pre><p>这两个方法的代码告诉我们，在获取和当前线程绑定的值时，ThreadLocalMap 对象是以 this 指向的 ThreadLocal 对象为键进行查找的，这当然和前面set()方法的代码是呼应的。</p>
<h4 id="三、探究一下为什么这么设计？">三、探究一下为什么这么设计？</h4><p>ThreadLocal ，从名字就可以翻译为线程的本地存储。这是一种对共享资源安全使用的方法，但是和 synchronized 有区别，它为每个线程都分配一个变量的内存空间，根除了线程对共享变量的竞争。但是因为每个线程，所以这个变量在不同线程之间是“透明的”、“无法感知的”，这就意味着各个线程的这个变量不能有联系，它只和当前的线程相关联。</p>
<p>用一个例子来说明吧：</p>
<pre><code><span class="keyword">import</span> java.util.Random;
<span class="keyword">import</span> java.util.concurrent.ExecutorService;
<span class="keyword">import</span> java.util.concurrent.Executors;
<span class="keyword">import</span> java.util.concurrent.TimeUnit;

<span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
        <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) {
            ThreadLocalTest.increment();
            System.out.println(<span class="keyword">this</span>);
        }
    }

    <span class="keyword">public</span> <span class="function">String <span class="title">toString</span><span class="params">()</span> </span>{
        <span class="keyword">return</span> <span class="string">"thread is: "</span> + Thread.currentThread() + <span class="string">", value is: "</span> + ThreadLocalTest.get();
    }
}

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>{
    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; value = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;() {
        <span class="keyword">private</span> Random random = <span class="keyword">new</span> Random(<span class="number">47</span>);

        <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="function">Integer <span class="title">initialValue</span><span class="params">()</span> </span>{
            <span class="function"><span class="keyword">return</span> random.<span class="title">nextInt</span><span class="params">(<span class="number">10000</span>)</span></span>;
        }
    };

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>{
        value.set(value.get() + <span class="number">1</span>);
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>{
        <span class="function"><span class="keyword">return</span> value.<span class="title">get</span><span class="params">()</span></span>;
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>{
        ExecutorService exec = Executors.newCachedThreadPool();
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) {
            exec.execute(<span class="keyword">new</span> Task());
        }
        TimeUnit.SECONDS.sleep(<span class="number">3</span>);
        exec.shutdownNow();
    }
}
</code></pre><p>输出我就不贴了，运行一下就会发现。每个线程都会维护一个 value，而且相互不会影响。</p>
<p>但是仔细观察这个程序也许会发现一个问题：</p>
<blockquote>
<p>为什么 ThreadLocal 是 static 的？既然是跟线程有关的，那么为啥要声明为静态变量？静态的意思是所有对象公用一个，而 ThreadLocal 刚刚才说是线程本地，每个线程各自都有单独的一份。这是为什么呢?</p>
</blockquote>
<p>首先自然是文档，然后源码，然后去 stackoverflow 搜索，比如<a href="http://stackoverflow.com/questions/2784009/why-should-java-threadlocal-variables-be-static" target="_blank" rel="external">Why should Java ThreadLocal variables be static</a>。我个人试着总结一下吧。</p>
<blockquote>
<p>首先，TLS 的概念来源于 C 语言，详细的可以参考这篇文章——<a href="http://www.longene.org/techdoc/0328131001224576926.html" target="_blank" rel="external">漫谈兼容内核</a>。其实多线程的提出，最需要解决的是可视性问题，也就是前面提到的对共享资源的正确使用。对于有些共享资源，我希望所有线程可见，于是我在进程级别声明即可（也就是常见的全局变量），这样所有线程都可以任意访问，这时为了防止污染，就需要加锁进行串行访问；对于有些资源，我仅仅希望在本线程可见，不能让其他线程污染，这样很容易想到在线程内部声明局部变量，但是这么做有个头疼的问题是局部变量有作用域，如果我的线程需要横跨多个函数，那么我需要一层一层传递。举个极端的例子，如果有个线程 A 吧，A 启动时会调用 a()，然后 a()中调b(),b()中调 c(),……共有100层方法调用，且只有第1层和第100层用到了一个想在线程内部使用的局部变量，那么我就需要在100层函数的每一层都传递这个变量。这样做显然是下下之选，因为不仅容易出错，而且维护起来也非常容易让人困惑（我靠，这个函数传入的这个参数压根没用到，估计谁忘了吧，好，我来删了。然后……）。为了解决这种问题 TLS 应运而生。本质来说，TLS 可以理解为线程上下文变量。举个最简单的例子，假设我的程序会连续启动10个线程去读取10个文件的内容，线程代码是完全一样的。那么，我就可以使用 TLS 来记录线程上下文中的文件句柄（我在一个数组中定义了10个文件的句柄，然后用循环让一个线程领取一个句柄）。此时，我使用一致的文件操作代码，却能保证不管在任何线程中操作的文件句柄都是和该线程唯一绑定且其他线程不可见的。</p>
</blockquote>
<p>简单来说，TLS 的作用可以归纳为两点：</p>
<ul>
<li>存储线程上下文相关的信息，使得在一致的代码中，自动访问差异性的线程绑定的上下文相关信息(多态，有木有！)</li>
<li>解决了在全局（线程内部）使用“局部变量”的参数传递问题（其实也是得益于第一条）</li>
</ul>
<p>其实基于 C 语言，TLS 还可以理解的更简单：</p>
<ol>
<li>全局对象——全局变量的作用域和生命周期都是全局的，这里的全局是指进程级别。也就是说，如果你将其设置为全局变量，就意味着你希望在多线程环境中仍然能并发访问。但有时候不希望多线程同时访问，因为可能会造成变量污染，于是引入了线程互斥访问，互斥的作用就是保证多线程串行访问共享资源。</li>
<li>局部变量——如果设计的时候希望将某个变量设计为线程级别的，那典型做法是将其设计为函数的局部变量。可是，我如果又希望在线程执行时，这个线程用到的任意函数里面都可以访问到它。为了满足这个需求，又可能会想到用全局变量，但是，它又会使得这种访问域上升到进程级别。其实，我只是想在线程局部环境中，全局访问该变量而已。此时 TLS 应运而生，做到了这种<strong>在线程局部环境（或者称呼为线程执行环境，线程上下文）下可以全局访问该变量的效果</strong>。</li>
</ol>
<h4 id="四、实际中如何正确使用？">四、实际中如何正确使用？</h4><p>在一个支持单进程，多线程的轻量级移动平台中，假设我实现了一个 APP Framework，每一个 APP 都单独运行在一个独立的线程中，APP 运行时关联了很多信息，比如打开的文件、引用的组件、启动的 Timer 等。我希望框架能实现自动垃圾回收，就是当应用退出时，即使该 APP 没有主动释放打开的文件句柄，没有主动 cancel Timer，没有主动释放组件的引用，框架也可以自动完成这些收尾工作，否则，必定会造成内存耗尽（内存泄露）。 </p>
<p>假设 APP 退出时调用了框架的 ExitApp API，该 API 允许 APP 调用后关闭自己，也允许关闭别的 APP。 那么，假设该 API 触发了 APP 的退出，最终调用到框架的 App_CleanUp() 函数，那么 App_CleanUp() 函数除了完成 APP 本身实例的释放外，肯定也要将那些文件句柄啊、Timer 啊、组件等资源释放掉。怎么来做呢？如果理解了上面的 ThreadLocal 的概念， 很明显这里可以使用 TLS。具体方法如下：</p>
<ol>
<li>在 Framework 的 API 中，当 APP 的线程启动时，new 一个 AppContext 的对象，然后将对象的指针以 TLS 的方式存储起来。而这个 AppContext 内部包含了文件句柄，timer引用，组件引用等等。</li>
<li>后续任何框架的文件操作/Timer操作/组件使用，都可以取当前线程的 TLS，然后拿出 AppContext，将更新的文件句柄、Timer、组件使用等更新在 AppContext 对象内部。</li>
<li>应用退出时获取 TLS，拿到 AppContext，取出 AppContext 中的文件句柄，组件引用，Timer引用等完成清理工作。</li>
</ol>
<h4 id="五、有什么缺点？有危险吗？">五、有什么缺点？有危险吗？</h4><p>听说有内存泄露，但是感觉不会。因为 ThreadLocal 是和 Thread 绑定的，线程死亡的时候，作为线程的属性，是肯定会被清理的啊。怎么会造成内存泄露呢？（因为 ThreadLocal 是线程内部的嘛）看了一些资料是这样说的：</p>
<ul>
<li><a href="http://stackoverflow.com/questions/17968803/threadlocal-memory-leak" target="_blank" rel="external">ThreadLocal &amp; Memory Leak</a></li>
<li><a href="http://my.oschina.net/xpbug/blog/113444" target="_blank" rel="external">反驳:Threadlocal存在内存泄露</a></li>
<li><a href="http://liuinsect.iteye.com/blog/1827012" target="_blank" rel="external">ThreadLocal内存泄露分析</a></li>
</ul>
<p>有的说有泄露，有的说没泄露。。。。嗯，其实没有仔细看。等我仔细研究过再来总结。</p>
<p>——————————-先挖个坑——————————</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://mwplll.github.io/2015/08/17/理解ThreadLocal/" data-title="理解ThreadLocal | 特喜欢秋天的人" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/17/Java编程思想-第二十一章、并发（四）/" title="Java编程思想-第二十一章、并发（四）">
  <strong>上一篇：</strong><br/>
  <span>
  Java编程思想-第二十一章、并发（四）</span>
</a>
</div>


<div class="next">
<a href="/2015/08/16/Java编程思想-第二十一章、并发（三）/"  title="Java编程思想-第二十一章、并发（三）">
 <strong>下一篇：</strong><br/> 
 <span>Java编程思想-第二十一章、并发（三）
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/08/17/理解ThreadLocal/" data-title="理解ThreadLocal" data-url="http://mwplll.github.io/2015/08/17/理解ThreadLocal/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一、什么是_ThreadLocal，为什么要提出这个概念？"><span class="toc-number">1.1.</span> <span class="toc-text">一、什么是 ThreadLocal，为什么要提出这个概念？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二、文档_&_源码分析"><span class="toc-number">1.2.</span> <span class="toc-text">二、文档 & 源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三、探究一下为什么这么设计？"><span class="toc-number">1.3.</span> <span class="toc-text">三、探究一下为什么这么设计？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四、实际中如何正确使用？"><span class="toc-number">1.4.</span> <span class="toc-text">四、实际中如何正确使用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#五、有什么缺点？有危险吗？"><span class="toc-number">1.5.</span> <span class="toc-text">五、有什么缺点？有危险吗？</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/C/" title="C">C<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/leetcode/" title="leetcode">leetcode<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/markdown/" title="markdown">markdown<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/前端/" title="前端">前端<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/操作系统/" title="操作系统">操作系统<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/求职笔试面试/" title="求职笔试面试">求职笔试面试<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/笔试面试/" title="笔试面试">笔试面试<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>27</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/算法/" title="算法">算法<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/Java编程思想/" title="Java编程思想">Java编程思想<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/排序/" title="排序">排序<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/树/" title="树">树<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/基础/" title="基础">基础<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/图/" title="图">图<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/c/" title="c">c<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/经验/" title="经验">经验<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/数据结构/" title="数据结构">数据结构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/面试/" title="面试">面试<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/操作系统/" title="操作系统">操作系统<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/leetcode/" title="leetcode">leetcode<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/散列/" title="散列">散列<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/鸟哥的Linux私房菜/" title="鸟哥的Linux私房菜">鸟哥的Linux私房菜<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/前端/" title="前端">前端<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/学习资料/" title="学习资料">学习资料<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/堆/" title="堆">堆<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C">C<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello ,I&#39;m Mao Weipeng in ZJU. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:maoweipeng@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="威威小威">威威小威</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"mwplll"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fnull' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
