
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Java编程思想-第二十一章、并发（六） | 特喜欢秋天的人</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="威威小威">
    

    
    <meta name="description" content="21.6 线程死锁关于死锁的问题，是非常麻烦的。对一般程序而言，如果马上出问题，你就可以立即跟踪下去。但是线程死锁不会马上出问题，看起来工作良好的程序却具有潜在的死锁风险。因此，在编写并发程序的时候，进行仔细的程序设计以防止死锁是关键部分。
先解释一下线程死锁吧：

某个任务在等待另一个任务，而后者又等待别的任务，这样一直下去，直到这条链条上的任务又在等待第一个任务释放锁。这得到了一个任务之间相互">
<meta property="og:type" content="article">
<meta property="og:title" content="Java编程思想-第二十一章、并发（六）">
<meta property="og:url" content="http://mwplll.github.io/2015/08/17/Java编程思想-第二十一章、并发（六）/index.html">
<meta property="og:site_name" content="特喜欢秋天的人">
<meta property="og:description" content="21.6 线程死锁关于死锁的问题，是非常麻烦的。对一般程序而言，如果马上出问题，你就可以立即跟踪下去。但是线程死锁不会马上出问题，看起来工作良好的程序却具有潜在的死锁风险。因此，在编写并发程序的时候，进行仔细的程序设计以防止死锁是关键部分。
先解释一下线程死锁吧：

某个任务在等待另一个任务，而后者又等待别的任务，这样一直下去，直到这条链条上的任务又在等待第一个任务释放锁。这得到了一个任务之间相互">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java编程思想-第二十一章、并发（六）">
<meta name="twitter:description" content="21.6 线程死锁关于死锁的问题，是非常麻烦的。对一般程序而言，如果马上出问题，你就可以立即跟踪下去。但是线程死锁不会马上出问题，看起来工作良好的程序却具有潜在的死锁风险。因此，在编写并发程序的时候，进行仔细的程序设计以防止死锁是关键部分。
先解释一下线程死锁吧：

某个任务在等待另一个任务，而后者又等待别的任务，这样一直下去，直到这条链条上的任务又在等待第一个任务释放锁。这得到了一个任务之间相互">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="特喜欢秋天的人">特喜欢秋天的人</a></h1>
				<h2 class="blog-motto">keep going，多尝试，就不会害怕...</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/categories">分类</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:mwplll.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/17/Java编程思想-第二十一章、并发（六）/" title="Java编程思想-第二十一章、并发（六）" itemprop="url">Java编程思想-第二十一章、并发（六）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="威威小威" target="_blank" itemprop="author">威威小威</a>
		
  <p class="article-time">
    <time datetime="2015-08-17T08:06:31.000Z" itemprop="datePublished"> 发表于 2015-08-17</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-6_线程死锁"><span class="toc-number">1.</span> <span class="toc-text">21.6 线程死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-_哲学家进餐"><span class="toc-number">1.1.</span> <span class="toc-text">1. 哲学家进餐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-_本节习题"><span class="toc-number">1.2.</span> <span class="toc-text">2. 本节习题</span></a></li></ol></li></ol>
		
		</div>
		
		<h3 id="21-6_线程死锁">21.6 线程死锁</h3><p>关于死锁的问题，是非常麻烦的。对一般程序而言，如果马上出问题，你就可以立即跟踪下去。但是线程死锁不会马上出问题，看起来工作良好的程序却具有潜在的死锁风险。因此，在编写并发程序的时候，进行仔细的程序设计以防止死锁是关键部分。</p>
<p>先解释一下线程死锁吧：</p>
<blockquote>
<p>某个任务在等待另一个任务，而后者又等待别的任务，这样一直下去，直到这条链条上的任务又在等待第一个任务释放锁。这得到了一个任务之间相互等待的连续循环，没有哪个线程能继续运行，这就被称为线程死锁。</p>
</blockquote>
<h4 id="1-_哲学家进餐">1. 哲学家进餐</h4><p>哲学家进餐是一个典型的线程死锁例子，我就不多描述场景了，直接上程序模拟(省略了一些 import 语句，请自行添加)：</p>
<pre><code><span class="keyword">class</span> Chopstick {
    <span class="keyword">private</span> <span class="keyword">boolean</span> taken = <span class="keyword">false</span>;

    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> take() <span class="keyword">throws</span> InterruptedException {
        <span class="keyword">while</span>(taken) {
            wait();
        }

        taken = <span class="keyword">true</span>;
    }

    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> drop() {
        taken = <span class="keyword">false</span>;
        notifyAll();
    }
}

<span class="comment">/**
 * 每个哲学家都是一个 Runnable 任务
 */</span>
<span class="keyword">class</span> Philosopher <span class="keyword">implements</span> Runnable {

    <span class="keyword">private</span> Chopstick left;
    <span class="keyword">private</span> Chopstick right;
    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;
    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ponderFctor;
    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);

    <span class="keyword">public</span> Philosopher(Chopstick left, Chopstick right, <span class="keyword">int</span> id, <span class="keyword">int</span> ponder) {
        <span class="keyword">this</span>.left = left;
        <span class="keyword">this</span>.right = right;
        <span class="keyword">this</span>.id = id;
        <span class="keyword">this</span>.ponderFctor = ponder;
    }

    <span class="comment">// 思考的时间</span>
    <span class="keyword">private</span> <span class="keyword">void</span> pause() <span class="keyword">throws</span> InterruptedException {
        <span class="comment">//不思考</span>
        <span class="keyword">if</span> (ponderFctor == <span class="number">0</span>) {
            <span class="keyword">return</span>;
        }
        TimeUnit.MILLISECONDS.sleep(rand.nextInt(ponderFctor * <span class="number">250</span>));
    }

    @Override
    <span class="keyword">public</span> <span class="keyword">void</span> run() {
        <span class="keyword">try</span> {
            <span class="keyword">while</span> (!Thread.interrupted()) {
                <span class="comment">// 思考</span>
                System.out.<span class="keyword">print</span>(<span class="keyword">this</span> + <span class="string">" thinking..."</span>);
                pause();

                <span class="comment">// 饿了</span>
                System.out.<span class="keyword">println</span>(<span class="keyword">this</span> + <span class="string">" grabbing right"</span>);
                right.take();
                System.out.<span class="keyword">println</span>(<span class="keyword">this</span> + <span class="string">" garbbing left"</span>);
                left.take();
                System.out.<span class="keyword">println</span>(<span class="keyword">this</span> + <span class="string">" eating..."</span>);
                pause();

                <span class="comment">//吃完了</span>
                right.drop();
                left.drop();

            }
        } <span class="keyword">catch</span> (InterruptedException e) {
            System.out.<span class="keyword">println</span>(<span class="keyword">this</span> + <span class="string">" exiting via interrupt"</span>);
        }
    }

    @Override
    <span class="keyword">public</span> String toString() {
        <span class="keyword">return</span> <span class="string">"Philosopher "</span> + id + <span class="string">"号"</span>;
    }
}

<span class="comment">/**
 * Args: 0 5 timeout
 * 
 *  0:是思考时间的因子
 *  5:筷子数目
 *  timeout:停止时间
 */</span>
<span class="keyword">public</span> <span class="keyword">class</span> DeadlockingDiningPhilosophers {
    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) <span class="keyword">throws</span> Exception {
        <span class="keyword">int</span> ponder = <span class="number">5</span>;
        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) {
            ponder = Integer.parseInt(args[<span class="number">0</span>]);
        }
        <span class="keyword">int</span> <span class="keyword">size</span> = <span class="number">5</span>;
        <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>) {
            <span class="keyword">size</span> = Integer.parseInt(args[<span class="number">1</span>]);
        }

        ExecutorService exec = Executors.newCachedThreadPool();
        Chopstick[] chopsticks = <span class="keyword">new</span> Chopstick[<span class="keyword">size</span>];
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">size</span>; i++) {
            chopsticks[i] = <span class="keyword">new</span> Chopstick();
        }
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">size</span>; i++) {
            exec.execute(<span class="keyword">new</span> Philosopher(chopsticks[i], chopsticks[(i + <span class="number">1</span>) % <span class="keyword">size</span>], i, ponder));
        }
        <span class="keyword">if</span> (args.length == <span class="number">3</span> &amp;&amp; args[<span class="number">2</span>].equals(<span class="string">"timeout"</span>)) {
            TimeUnit.SECONDS.sleep(<span class="number">5</span>);
        } <span class="keyword">else</span> {
            System.out.<span class="keyword">println</span>(<span class="string">"Press 'Enter' to quit"</span>);
            System.in.<span class="keyword">read</span>();
        }
        exec.shutdownNow();
    }
}
</code></pre><p>这个程序不指定参数的话，就是0 5，然后按 Enter 停止；如果指定0 5 timeout，就在5s 后自动停止。不过悲催的是，我运行了几十次，一共就产生了1次死锁。。。其中有次运行了3个小时也没死锁 T_T 可见死锁问题的隐蔽性啊。</p>
<p>那么，死锁问题是不可能避免的吗？Nope.其实线程死锁必须<strong>同时满足以下四个条件（一定是同时）</strong>：</p>
<ul>
<li>互斥条件。各个任务使用的资源至少有一个是不同共享的，属于临界资源。比如上面的筷子</li>
<li>至少有一个任务必须占有资源的同时想获取另外一个或可用或被其他任务占用的资源</li>
<li>资源不能被抢占。意思是大家都平等，不能强行抢夺别人的资源</li>
<li>必须有循环等待。就像开头描述的那样，大家要形成一个闭环</li>
</ul>
<p>因为发生死锁要同时满足四个条件，那么解除死锁只需要破坏其中的一个即可。一般情况下，最容易防止死锁的方法是<strong>破坏第四个条件</strong>。</p>
<p>比如上面的哲学家就餐问题，第四个条件是因为哲学家都先拿右边，然后拿左边。因为是圆桌，所以最后一个哲学家和第一个哲学家就会抢占它们中间的筷子形成闭环。解决方法很简单：如果最后一个哲学家被初始化为先拿左边的筷子，然后再拿右边的筷子，那么这个哲学家将永远不会阻止他右边的哲学家拿起筷子。</p>
<h4 id="2-_本节习题">2. 本节习题</h4><p>这个小节有一个习题，说的是把筷子集中放到一个容器中，每个哲学家要就餐的话，就取出两根筷子，用完就放进去。这样能防止死锁吗？</p>
<p>关于死锁的问题，一定要往四个条件上靠拢。所以，我们看看他能破坏哪个条件，如果破坏了任意一个，就一定能解决死锁。那我们逐一分析：</p>
<ul>
<li>互斥条件：满足。两根筷子要么在容器中，要么在哲学家手中。不能共享</li>
<li>占着一个，想要另外一个：Bingo！因为我只要拿到筷子，就一定是两根，而且不会再去拿容器中的筷子。所以这个条件不满足</li>
<li>资源不能被抢占：满足。</li>
<li>循环等待：没有循环等待，因为两根筷子捆绑一会，只有一种情况，拿或者没拿。不会产生循环</li>
</ul>
<p>综上，从第二条我们就知道，这种方法不会产生死锁。官方答案是这样的：</p>
<blockquote>
<p>We use ChopstickQueue to create the ChopstickBin, so it gains all of LinkedBlockingQueue’s control logic. Instead of picking up the left and right chopsticks, philosophers take them from a common bin, an activity we suspend when too few chopsticks remain. The results are the same, with the flaw that an equal number of chopsticks and philosophers can quickly deadlock, but a single extra chopstick prevents this.</p>
</blockquote>
<p>很悲催，我们想错了。那么错在哪里了？</p>
<blockquote>
<p>其实是理解错题意了。囧 rz。人家没说一次拿两根，而是拿完一根再拿一根。。。。。。。那么，5个哲学家、5根筷子，启动时，所有哲学家都饿了，同时去拿1根。。。然后就悲剧了。。。同时4条件也满足了。所以，如果是拿两根筷子作为一个原子操作，就不会产生死锁了。</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java编程思想/">Java编程思想</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://mwplll.github.io/2015/08/17/Java编程思想-第二十一章、并发（六）/" data-title="Java编程思想-第二十一章、并发（六） | 特喜欢秋天的人" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/17/Java编程思想-第二十一章、并发（七）/" title="Java编程思想-第二十一章、并发（七）">
  <strong>上一篇：</strong><br/>
  <span>
  Java编程思想-第二十一章、并发（七）</span>
</a>
</div>


<div class="next">
<a href="/2015/08/17/Java编程思想-第二十一章、并发（五）/"  title="Java编程思想-第二十一章、并发（五）">
 <strong>下一篇：</strong><br/> 
 <span>Java编程思想-第二十一章、并发（五）
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/08/17/Java编程思想-第二十一章、并发（六）/" data-title="Java编程思想-第二十一章、并发（六）" data-url="http://mwplll.github.io/2015/08/17/Java编程思想-第二十一章、并发（六）/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-6_线程死锁"><span class="toc-number">1.</span> <span class="toc-text">21.6 线程死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-_哲学家进餐"><span class="toc-number">1.1.</span> <span class="toc-text">1. 哲学家进餐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-_本节习题"><span class="toc-number">1.2.</span> <span class="toc-text">2. 本节习题</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/C/" title="C">C<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/leetcode/" title="leetcode">leetcode<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/markdown/" title="markdown">markdown<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/svn/" title="svn">svn<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/操作系统/" title="操作系统">操作系统<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/求职笔试面试/" title="求职笔试面试">求职笔试面试<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Java编程思想/" title="Java编程思想">Java编程思想<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/基础/" title="基础">基础<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/算法/" title="算法">算法<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/c/" title="c">c<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/数据结构/" title="数据结构">数据结构<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/leetcode/" title="leetcode">leetcode<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/经验/" title="经验">经验<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/面试/" title="面试">面试<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/操作系统/" title="操作系统">操作系统<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/排序/" title="排序">排序<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/svn/" title="svn">svn<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C">C<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello ,I&#39;m Mao Weipeng in ZJU. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:maoweipeng@126.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="威威小威">威威小威</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"mwplll"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fnull' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
